package Validator;

import java.util.regex.Pattern;
import java.util.regex.Matcher;
import javax.naming.directory.Attributes;
import javax.naming.directory.DirContext;
import javax.naming.directory.InitialDirContext;
import java.util.Hashtable;

public class MailValidator {

    // Regex für E-Mail-Format
    private static final String EMAIL_REGEX = "^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$";
    private static final Pattern EMAIL_PATTERN = Pattern.compile(EMAIL_REGEX);

    /**
     * Validiert eine E-Mail-Adresse auf Format und Domain (MX-Record)
     * @param email Die zu prüfende E-Mail-Adresse
     * @throws Exception Wenn die E-Mail ungültig ist oder die Domain keinen MX-Record hat
     */
    public static void validate(String email) throws Exception {
        if (email == null || email.isEmpty()) {
            throw new Exception("E-Mail-Adresse darf nicht leer sein.");
        }

        // 1. Syntax-Prüfung
        if (!isValidSyntax(email)) {
            throw new Exception("Ungültiges E-Mail-Format: " + email);
        }

        // 2. Domain-Prüfung (MX-Record)
        String domain = extractDomain(email);
        if (!hasMXRecord(domain)) {
            throw new Exception("Domain '" + domain + "' hat keinen gültigen MX-Record.");
        }
    }

    /**
     * Prüft, ob die E-Mail-Adresse dem Standardformat entspricht
     * @param email Die zu prüfende E-Mail-Adresse
     * @return true, wenn das Format gültig ist
     */
    private static boolean isValidSyntax(String email) {
        Matcher matcher = EMAIL_PATTERN.matcher(email);
        return matcher.matches();
    }

    /**
     * Extrahiert die Domain aus einer E-Mail-Adresse
     * @param email Die E-Mail-Adresse
     * @return Die Domain (alles nach @)
     */
    private static String extractDomain(String email) {
        return email.substring(email.lastIndexOf("@") + 1);
    }

    /**
     * Prüft, ob die Domain einen MX-Record besitzt
     * @param domain Die Domain
     * @return true, wenn ein MX-Record existiert
     */
    private static boolean hasMXRecord(String domain) {
        try {
            Hashtable<String, String> env = new Hashtable<>();
            env.put("java.naming.factory.initial", "com.sun.jndi.dns.DnsContextFactory");
            DirContext ctx = new InitialDirContext(env);
            Attributes attrs = ctx.getAttributes(domain, new String[]{"MX"});
            return attrs.get("MX") != null;
        } catch (Exception e) {
            return false;
        }
    }
}
